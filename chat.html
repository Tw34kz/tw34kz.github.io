<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Twitch Chat Overlay</title>
<style>
body{margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;background:transparent;overflow:hidden;}
#chat-container{position:absolute;bottom:0;width:340px;max-height:70vh;display:flex;flex-direction:column-reverse;gap:12px;overflow-y:auto;padding:10px;}
.chat-message{display:flex;flex-direction:column;border-radius:20px;padding:10px 16px;box-shadow:0 4px 8px rgba(0,0,0,0.2);opacity:0;transform:translateY(10px);background-size:200% 200%;animation:fadeIn 0.3s ease forwards, gradientMove 6s ease infinite;}
.username{font-weight:bold;font-size:14px;color:#333;display:flex;align-items:center;gap:4px;margin-bottom:4px;}
.badge{width:16px;height:16px;}
.message-text{font-size:14px;color:#222;line-height:1.3;display:flex;flex-wrap:wrap;gap:2px;}
#debug-log{position:absolute;top:0;left:0;width:100%;font-size:12px;color:#f00;}
@keyframes fadeIn{to{opacity:1;transform:translateY(0);}}
@keyframes floatAway{0%{opacity:1;transform:translateY(0) rotate(0deg);}25%{transform:translateY(-5px) rotate(-1deg) translateX(2px);}50%{transform:translateY(-15px) rotate(1deg) translateX(-2px);}75%{transform:translateY(-25px) rotate(-2deg) translateX(1px);}100%{opacity:0;transform:translateY(-40px) rotate(3deg) translateX(-3px);}}
@keyframes gradientMove{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
.fade-out{animation:floatAway 1.5s forwards;}
#idle-gif{position:absolute;top:50%;left:50%;width:180px;height:180px;transform:translate(-50%,-50%) scale(0.8);display:none;opacity:0;transition:opacity 0.6s ease,transform 0.6s ease;}
#idle-gif.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1);}
#idle-gif.hide{opacity:0;transform:translate(-50%,-50%) scale(0.8);}
</style>
</head>
<body>

<div id="chat-container"></div>
<img id="idle-gif" src="https://i.imgur.com/idle.gif" alt="Idle animation">
<div id="debug-log"></div>

<!-- tmi.js via jsDelivr -->
<script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
<script>
const chatContainer = document.getElementById('chat-container');
const idleGif = document.getElementById('idle-gif');
const debugLog = document.getElementById('debug-log');
let idleTimer;

// Hardcoded badges
const badgeUrls = {
  moderator:'https://static-cdn.jtvnw.net/badges/v1/1f0d7f7e-.../1',
  subscriber:'https://static-cdn.jtvnw.net/badges/v1/0db7d3.../1',
  vip:'https://static-cdn.jtvnw.net/badges/v1/8e2.../1'
};

// Gradients
const gradients=[
  'linear-gradient(120deg,#ffd6d6,#ffe4b3)',
  'linear-gradient(120deg,#d6f0ff,#c8e4ff)',
  'linear-gradient(120deg,#d6ffd8,#c8ffe4)',
  'linear-gradient(120deg,#f0d6ff,#e4c8ff)'
];
function getRandomGradient(){return gradients[Math.floor(Math.random()*gradients.length)];}

// Voeg bericht toe
function addMessage(username,text,badges=[]){
  resetIdle();
  const msgEl=document.createElement('div');
  msgEl.classList.add('chat-message');
  msgEl.style.background=getRandomGradient();

  const userEl=document.createElement('div');
  userEl.classList.add('username');
  badges.forEach(url=>{const badge=document.createElement('img');badge.src=url;badge.classList.add('badge');userEl.appendChild(badge);});
  userEl.appendChild(document.createTextNode(username));
  msgEl.appendChild(userEl);

  const textEl=document.createElement('div');
  textEl.classList.add('message-text');
  textEl.innerHTML=text;
  msgEl.appendChild(textEl);

  chatContainer.prepend(msgEl);
  setTimeout(()=>msgEl.classList.add('fade-out'),15000);
  setTimeout(()=>msgEl.remove(),16500);

  debugLog.innerText=`Last message: ${username}: ${text}`;
  startIdleTimer();
}

// Idle GIF
function startIdleTimer(){clearTimeout(idleTimer);idleTimer=setTimeout(()=>{idleGif.classList.remove('hide');idleGif.classList.add('show');},20000);}
function resetIdle(){idleGif.classList.remove('show');idleGif.classList.add('hide');}

// --- OAuth token uit URL fragment ---
const urlHash=window.location.hash;
let token='';
if(urlHash.includes('access_token')){token=urlHash.split('access_token=')[1].split('&')[0];}

// tmi.js client
if(token){
  const client = new tmi.Client({
    options:{debug:true},
    identity:{username:'kulkrix', password:'oauth:'+token},
    channels:['kulkrix']
  });

  client.connect().then(()=>debugLog.innerText='Connected to Twitch chat!').catch(err=>debugLog.innerText='Connect error: '+err);

  client.on('message',(channel,tags,message,self)=>{
    // tijdelijk self check uit, zodat je je eigen berichten ziet
    // if(self) return;

    const badges=[];
    if(tags.badges){
      for(const [badge,level] of Object.entries(tags.badges)){
        if(badgeUrls[badge]) badges.push(badgeUrls[badge]);
      }
    }
    addMessage(tags['display-name'],message,badges);
  });
}else{
  debugLog.innerText='Geen OAuth token gevonden. Voeg #access_token=XXXX toe in de URL.';
}
</script>
</body>
</html>
